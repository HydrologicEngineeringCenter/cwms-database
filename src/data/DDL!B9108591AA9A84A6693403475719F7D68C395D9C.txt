
  CREATE TABLE "CWMS_20"."CWMS_UNIT_CONVERSION" 
   (	"FROM_UNIT_ID" VARCHAR2(16) NOT NULL ENABLE, 
	"TO_UNIT_ID" VARCHAR2(16) NOT NULL ENABLE, 
	"ABSTRACT_PARAM_CODE" NUMBER(10,0) NOT NULL ENABLE, 
	"FROM_UNIT_CODE" NUMBER(10,0) NOT NULL ENABLE, 
	"TO_UNIT_CODE" NUMBER(10,0) NOT NULL ENABLE, 
	"FACTOR" BINARY_DOUBLE NOT NULL ENABLE, 
	"OFFSET" BINARY_DOUBLE NOT NULL ENABLE, 
	 CONSTRAINT "CWMS_UNIT_CONVERSION_PK" PRIMARY KEY ("FROM_UNIT_ID", "TO_UNIT_ID") ENABLE, 
	 CONSTRAINT "CWMS_UNIT_CONVERSION_FK1" FOREIGN KEY ("FROM_UNIT_CODE")
	  REFERENCES "CWMS_20"."CWMS_UNIT" ("UNIT_CODE") ENABLE, 
	 CONSTRAINT "CWMS_UNIT_CONVERSION_FK2" FOREIGN KEY ("TO_UNIT_CODE")
	  REFERENCES "CWMS_20"."CWMS_UNIT" ("UNIT_CODE") ENABLE, 
	 CONSTRAINT "CWMS_UNIT_CONVERSION_FK3" FOREIGN KEY ("FROM_UNIT_ID", "ABSTRACT_PARAM_CODE")
	  REFERENCES "CWMS_20"."CWMS_UNIT" ("UNIT_ID", "ABSTRACT_PARAM_CODE") ENABLE, 
	 CONSTRAINT "CWMS_UNIT_CONVERSION_FK4" FOREIGN KEY ("TO_UNIT_ID", "ABSTRACT_PARAM_CODE")
	  REFERENCES "CWMS_20"."CWMS_UNIT" ("UNIT_ID", "ABSTRACT_PARAM_CODE") ENABLE
   ) ORGANIZATION INDEX NOCOMPRESS PCTFREE 10 INITRANS 2 MAXTRANS 255 LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "CWMS_20DATA" 
 PCTTHRESHOLD 50
 
  CREATE UNIQUE INDEX "CWMS_20"."CWMS_UNIT_CONVERSION_PK" ON "CWMS_20"."CWMS_UNIT_CONVERSION" ("FROM_UNIT_ID", "TO_UNIT_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "CWMS_20DATA" 
 
  CREATE UNIQUE INDEX "CWMS_20"."CWMS_UNIT_CONVERSION_U01" ON "CWMS_20"."CWMS_UNIT_CONVERSION" ("FROM_UNIT_CODE", "TO_UNIT_CODE") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "CWMS_20DATA" 
 
  CREATE OR REPLACE TRIGGER "CWMS_20"."CWMS_UNIT_CONVERSION_UNIT" 
BEFORE INSERT OR UPDATE OF FROM_UNIT_CODE, TO_UNIT_CODE
ON CWMS_UNIT_CONVERSION
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
DECLARE
   --
   -- This trigger ensures that the abstract parameter associated with the source unit
   -- is the same as the abstract parameter associated with the destination unit.
   --
   FROM_ABSTRACT_CODE          CWMS_ABSTRACT_PARAMETER.ABSTRACT_PARAM_CODE%TYPE;
   FROM_ABSTRACT_ID            CWMS_ABSTRACT_PARAMETER.ABSTRACT_PARAM_ID%TYPE;
   FROM_ID                     CWMS_UNIT.UNIT_ID%TYPE;
   TO_ABSTRACT_CODE            CWMS_ABSTRACT_PARAMETER.ABSTRACT_PARAM_CODE%TYPE;
   TO_ABSTRACT_ID              CWMS_ABSTRACT_PARAMETER.ABSTRACT_PARAM_ID%TYPE;
   TO_ID                       CWMS_UNIT.UNIT_ID%TYPE;
   INCONSISTENT_ABSTRACT_CODES EXCEPTION;
   PRAGMA EXCEPTION_INIT(INCONSISTENT_ABSTRACT_CODES, -20000);
BEGIN
   SELECT ABSTRACT_PARAM_CODE
      INTO   FROM_ABSTRACT_CODE
      FROM   CWMS_UNIT
      WHERE  UNIT_CODE = :NEW.FROM_UNIT_CODE;
   SELECT ABSTRACT_PARAM_CODE
      INTO   TO_ABSTRACT_CODE
      FROM   CWMS_UNIT
      WHERE  UNIT_CODE = :NEW.TO_UNIT_CODE;
   IF FROM_ABSTRACT_CODE != TO_ABSTRACT_CODE
   THEN
      RAISE INCONSISTENT_ABSTRACT_CODES;
   END IF;
EXCEPTION
   WHEN INCONSISTENT_ABSTRACT_CODES THEN
      SELECT UNIT_ID
         INTO   FROM_ID
         FROM   CWMS_UNIT
         WHERE  UNIT_CODE = :NEW.FROM_UNIT_CODE;
      SELECT UNIT_ID
         INTO   TO_ID
         FROM   CWMS_UNIT
         WHERE  UNIT_CODE = :NEW.TO_UNIT_CODE;
      SELECT ABSTRACT_PARAM_ID
         INTO   FROM_ABSTRACT_ID
         FROM   CWMS_ABSTRACT_PARAMETER
         WHERE  ABSTRACT_PARAM_CODE=FROM_ABSTRACT_CODE;
      SELECT ABSTRACT_PARAM_ID
         INTO   TO_ABSTRACT_ID
         FROM   CWMS_ABSTRACT_PARAMETER
         WHERE  ABSTRACT_PARAM_CODE=TO_ABSTRACT_CODE;
      DBMS_OUTPUT.PUT_LINE(
         'ERROR: From-unit "'
         || FROM_ID
         || '" has abstract parameter "'
         || FROM_ABSTRACT_ID
         || '" but To-unit "'
         || TO_ID
         || '" has abstract parameter "'
         || TO_ABSTRACT_ID
         || '".');
      RAISE;
   WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      RAISE;
END R_PARAMETER_UNIT;
ALTER TRIGGER "CWMS_20"."CWMS_UNIT_CONVERSION_UNIT" ENABLE
 