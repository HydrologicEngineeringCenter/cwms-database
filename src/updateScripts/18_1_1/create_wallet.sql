--
-- Selects a wallet directory (if not already set) based on the database installation and creates wallet there
--
set serveroutput on
declare
   l_property_value  varchar2(256);
   l_directory_names str_tab_t;
   l_file            utl_file.file_type;
   l_len             pls_integer;
   l_filename        varchar2(256);
   l_text            str_tab_t; 
   l_buf             raw(64); 
   
   l_cwallet_text clob := '
A1F84E360000000600000021067CBD7D67EF37A9FD81A172BD17FDBDE4ADE1815E1C42AF0965166A89D55F092C308209D40201033082099A06092A864886F70D
010701A082098B04820987308209833082097F06092A864886F70D010706A08209703082096C0201003082096506092A864886F70D010701301C060A2A864886
F70D010C0103300E0408BDDFF9C3E387A2FA0202040080820938315AA67EAD901032C4B093407E79350FE4E37B50C067EFC0DDD79F045909F38166A88877AA3A
8A7BE87A72AF99E41D0FB210B036EEC04E6D4AEE77CC097A307963723B6FE492F6DE03B225140151DD4C2AEE40B865D5E2DAD77C5B58D6A27B96B656A0879FE2
8E9E965A3C6BE5F56E5A81256F1E82B74B15C28DA77D5DB8A51D7B6D9A9899EB02EA704F56C497A424470A17D773F6D981EF86D2036163174772B7D61A7ECF57
FAD55657F90ED8E86354993A486B14EFF45AB16CFFA77B0AE2E7DE12A7CD0E3922EA6D4B702C75B1A2965CC33F375468BB2097FFCBA2DD813509EADC3AA78056
6FD01BE64893216B67E1821C60C43EE633CCA3397E871F29E9B0BB5CB666B1152886C8F6B0270405FE3C17166553E84F8E3A406D26E2A7C55EBB1A09BFEDE262
D8453BB88CB58A00A1E44479069F99DECB0F50BD2DC6108B602166B68B09224ADB5EDEA738873FFA4C5411F89403DB08A2ABF81CCCD6A5EF6F6B05350F5B07D5
7D887F66390C736811320A1F168A7E8D13B8D76F47A82C42771B4CCD7E420F5DFA494754F9507492AF8F52F61A37942340E80783B841159B9DB0823AD0627EB2
A6544FBDFF05ABE68B02095D4167A8072829EEB5DE0AF9D313767C72473236307EB9EEE17D2D52943B4C6849058DD0F82160AE556DB625411912BACE3085ACB7
BF0A6A49CCD621FC295CDBB0AE6ACA2EDAF4213506BB6AA5C4A9CCE1C2E43C526568634D4E73AEFE88751A7002CDD4F0DD6BFFED184D6D3477B8A4CCF75D5347
7DB6F9A3028C06C0FB6474A1E412CF781D9A5A68CABE4DEC52C1DA2DCD6C18D49B40B1B966867951055F2167FA3E0E73AF4B58A357F1FB4F428179BF4345812F
53DB4EDBC97350C1F8A119CCE15A1ADA17FEBF1F5E86434059DAA28F93C1D0AB2ECF8CE8952BCCDBC2227268F0E7E026B5FBB7EA3FAB338EF5DA3827C89F3E41
996336F21EF6A25023EFC8F6C68BF43E8B758010EE741CEC817A13C6847B93FBF0CDE63DF1EC3D46A7BDC5D3B7C52342833762998A39F09A6AFBEB64F1CD79A9
51175D7C1B953308EBCFD1D90D9602ABB981C7247FE4211885FF92108CCD0A1505A26F133E2F39EE8AC4E8ECEBB386E5B06B969A6964E070706C321A204E1FB9
7067A55D9A316A59BC6E17933B85B1DCBE1F55A4760F4CA891D3112E2FF899D50D77A1F8DB3A3C8379F892F4D63C866C0EDAE846C24F383EEE402D7E51D111AA
0AB7C751BD5352DEA2D6DE8E2CA8BD90372A7F5D4B7366BCA05FC9116EBE17B042513A43375B2BE865FF8F68BDAA7F3C6E158B79583860657B47936B7FBC1AAA
74AA9159EA1396CEDFE3B71857C6875AC1640BBD02C1F2BC20455E498832756C636DCFAE33475ECEEB298EABECA9750770D44DEC742EB5608CDAE2FD92449EB8
A7B3EFBB6BC80AD50B94EBB6763D4C0727E6C0D215FA4388D9FC4BEAD0492098DA9001B2B1FED76FB72DA3E94B1E8C3D4C1617C096460F2713E07EE0040D2200
216E96A7162ADC5D4F805AC916C80C5068F2B2047E567247536517DAA73F5F62FD0866385281377CF67A01B9A07F35FE8C64D1E20A801EB878926FA91183E760
1AE25B8923BB56B5E1024B51B254F7F67B30528BBF73C48D633D3A9401E4109A8A0DE7C66FDC03B3BA2E95872904F37566F2AEA09075AE969D4CE6EBA2D65E8C
8C45BBEC55855A005393D73EE1D4B084D10D0B5991CEEEED66E0B151FA79E2337297BC4DA1021A6C5AD103D5683D385F5EE034EF282C1963FFBFE5D306CB416C
4656A167A94C553EA805EA8F522D5F3AE4C0584C7CD47C6563607DA6E6D0F6C28C15702B95FF7070469087E1FBD6156DCA5C4663FE9060B5450177D8914A1695
9747C1FED00C0153D954581E238067C2D8D1823BE18E24FB00FB01255BB396DAAD1F203C245FD2F4825B7FC2EEC29E434472EB7A2460147006465A204F87E61A
64A8DF8CFAE27D53A6E76E394D2987F4EE08D910388329949B813AED49B1479C543FF077914E34DCD1ADEF6169CDD20FF026F3B47EC846E073C169EB88765F16
5AF50B984C3F0E223B9FE3354D29574FD8C7FEF41A6469C744F0D54708E8DB1AA2C8A429E9588E6035D26B4083765208A658EA51E4FBDCF33692774C85ECAB81
5B081DB3641B1B3ECAE7D448A431A29F5D48507FB2A0536EF9FC2B3F9331C136F578DE26EC7D2042D269B146B6AA2C1E99552D1650BFD8175ADC839C62052312
2255EC0ED295DDD4CC64DAA985A2C8F3057FCD26D0186101A0C16282FC812BBE3D71A1CB086217C98B79DD373EF09F66432503E5DDC7B839A9AC478BC6BB0A1D
AA1A360930895F72F4011AC802454E08E7E3458B948791D1B6FCDBFDA1050B734ABCAB6164B234973C9F687C57C716A67CA2E842F9659441C168837005EC7DE3
B884FE6792A976028DD7E9AF9AEFA0E1B47DDCBC83F7639D36D8E6518D52E1D82239118048F95B783B43BA636F01CAE657FAC004618776335E6DC5E5D18B338E
E17D0F9218CF2D8BD3DCF9085F85CFE63821AF689534F8776F178676DDBFB611CCCF1F459A225FB5A79FE3249BD02CB433F52C6A3FA469C5AAC0107966FF5623
FF25BA72E90165500A593A2EB1A428FC3E025AECAB6BE6961D531938648B12F59644AC130A5D662D1FBBC517BC0A5B21F592B7F0A89953D208EBFD58B1046316
AACA8C55F8545FE4AAB895F942F282A74720A9FAD22611E9CA5B012BC07735EF034CDA6D7756E274C76869B69755E539D488569ED9BF4DE9F51096E8D3D9D358
35777EA7EAC15A061904A8B6C7DF6D82D475CE7CF27BE2532BD853A866B0B8D0EE82EF2EE6A16AB4133F87723490121983D74CC770476DB7656DBE4295E3F79F
2F47FC2BF5B45594839A115C71B39FA30EE898EAA852CB199F7BEB673FD1F69EEBF1D925ACF2AB8F741125EF15A2B0923111875264030ED4C97EDA3612249845
18D73272C82EBC61BC5914552828F7649A71F1C84DF5B2298D085E480A574C0E338B43C4213E5E9F21460761ECAEC7E25B8BB7DCA6AFE8089A85DE9122AFE42F
F1105F4727E46552BA9C515B60967B640A36418F0D8EC8E880C1AF4620CCD9AD14B39404BA625D0CF134A0EF3BD81A20398E5E54257B1295846727ADCD7A1926
64F06E42DE57EDDF4B3723BEDDA298F8A0FE6C533327C3CCA64982A46C392A92CBECEBCBEF2D2C7ED5F1FB6D3A4788B87B136A6837396A6A96ECA8CBF283F289
B0DADD2A59F1E33BC02B0BC457BDB225EAF5E55A5D21F8D7B853C69B9A5251BED76CE344DFC65D501988B8823A62C2BBDE0CABD607B2913A67A22EB9735E509C
077045EB20ECF8BF4D5F7FA261AD902C5EF630313021300906052B0E03021A0500041416932E00B53CACDC2D123CE011479B9C864CF37F0408156441DE133D03
5702020400';

   l_ewallet_text clob := '
308209D40201033082099A06092A864886F70D010701A082098B04820987308209833082097F06092A864886F70D010706A08209703082096C02010030820965
06092A864886F70D010701301C060A2A864886F70D010C0103300E040897DABCF1B1B627890202040080820938B9B369B4541F180C5FF8BF23E546B7FC0FD3E2
E2C5E736E4E685CC9124D265528E5280636A1EC0FEE8E6D24B21FA5CD16D642D42530AE0482F9841CEB68B18ED6BE09214493AB87102DD281DEC40D7308B5B31
BD6696B91F39AF78582025D92D0838383789FCFF7E2E9D12AE8D0AE58873F9B3E99AC59CECC2060745B42DA6DD13FE921600ECCF3F2F4C385C0EBDCA45CC67F3
3ADEC91D7AA3DCD4C8C7A440E6FF3D8880FD5C32B216029B86FBDBE62729203F4E1ED236DA7A456AC141890E2FEFCBC6ADEEBF4DB61D12EFE27DA53DC922C221
F460D62955DE7A682CC97C159CCD9D8ECA563664E21FA5B2D0732518C483FBE4C68211EAE316EA2CA27264DC987457BF6FAA453E46375EF18345A20D92E4CE9B
12EB957A1C9AD6180E184739BAC8BC9E00F026BAAD7C77ECBD03B8AB72FF849B846E9DD0F481AE236E3E4F737A3B4C4571B57ADDE809BB0F1A865CF31B381071
75969A5A51D34974AFC79182CA4FF3D6E4AEFC7CE5DCF93700B6BDE9ED4DCE1D109BC65C54B677E8C133137C3FF0C232FEDE78C3516E24971C1A4029E452E974
F3BA395AD64BE36ABE267987C54E771EE1DFF8206BA655DF2C98BCDCEC4E87E276568F6BC2DED3554517E75C8501DBC19F7C616965F9E2A3605D33EE5B28DD79
370436011E1C405AD62B4D9C432ED5766B3D1B95D8F193D7327CDF98B437F7CD636BCA2939AAE262786DFB985BDD862C5CC0E8882C491C44B8FDE7635CE9EEA5
6F9C5A86165C8425D5098C18F3690A4232A941AB8D7D1F2636E0E2855B04A19C183B240AF46DC47E7BBDB5AFEFC4F9F907E575548CBD73EB782E5E32225A984F
D8F1B498973FDB0BB6FEC8EE4390953D7E737236870B13F38A8B1890C55F0CF76CAFF72B300831FB5EDF4D9B3D3881F5CE57118DC77810EC61F977BB719F165B
BEF18D5F97383615DEA7B03816CC933F9F17F7684C5846E3FDA3ADC86D120CD16CAFF5F76EADA69BACC95CBDCE16CD2F9B87C4B04928F8D08911E75F4CF2A677
715D55F2CF0F2A8C40A67D8819F8EC76B3C24ED062B987A2980F2874F050A43E4B618D46FA319FC7F60415C29A6776778E666A8322690DD885AFF7AF0C983DC0
5720E76A133DB1A755AF074ADCCA17DC75C261CAEBB5F2433962BDD32A332797060280ED5646F154C093F1DF71B38452F715ABFA880390F8DD4FB221BC02A37C
23AE75427E592A93420FF7CE81779A2374E5ED850E3F34EE6DDB2379F5CBAA0AE1E40C71B3BFC643F1125238D5B4CA5E080587532AE622A77B12942682EB5773
F0034E5EF949C58A287AB84E0B8C3F9DB94469D4858C31304058ADD550C368D2D1D0A3D6FA5E6406A10882C598DBCF8BF1039CCBF0E3DA80027327B76281FFC5
3627CCBE9588E1FC4307D258C5B586FACA3FC7144360E8565860D2F136E760A9C6F3C828B364629926636ECE413A0CBA30353C45AFECA97183481FAD67CC1527
09F1EC8AD4A1D40B577B732218CD1A5EBF3F124C9B487B5F0230DD4D2916D618AF50ADCF3F5A7F264ABA68283B75BCFADB26E87CBA57483B66847B9775535924
C23E9D40925E2A9FC9FD795949EC19B58BE12FD271C523C0BA1FB8CAD855B6810C96129A3E1E3081CFBDC2B213C78D8CF88407C7627A3316A835D56B6081391A
259172E7C21FDC65420060D9666DEA2D96D8525F1843F44B67CDBC3A7668481BF393E8CC636D4748EE8A665CAC62DAD525A8033141A3D035782EADC1A3F25B4D
AFC738258F6E9A7896AA694440D1A7313DA4D145F50A7C97F1E1A58E3D469AD291C16EB9BCDC6442511C954097EC059A9E1C94256568E3E7F53B4BA334EA429B
304965D8BB9200071263164783221F6613F480328D705495887C8E09836D1E03851D110B9BF63FF8279A4633A77C4076F3050793F68C8398F9C93424BBD74EF7
B7D3EED179F12A9605E4B9E84CA4E1933B4C453CE5877A3CE34CC13B3F2CE06D963B442F3FF8846A1D85F6A2C6FA7AE9C603268FEC7744F75FD1E70EFE6CA192
5B3CCB87683295177D3F10E76210F1D2E88239C61B0439F4DBF9C79F3ABB65CBA22CFD2D8964A96C644548E4DA70F1FBFD354BB43258562B548C686ECE03995C
A3FD289645B1B78314981C2CC5EA65CD4556C7879E987899F984E3C01A82B92D066ECE35CA6DBD54674B243A00084F762774572DD4F55C3EFDC2F03FD4BBB14A
7C596F3B5552B3E8CB2E9963FF691DAA4456BC014C9C01B833FBFB0374AEDC06A8A0FCA64F91F3CFA7682F835FAF25CCFEDD4979A1D1F9FF3698B28AC6F28E69
9BB372335851BC1EE28CA6AACE5C7026E74AA9AD08C175DB2854479EEF2C292D997F6230BF2C34FF8652590382D324633515D539CC53E64A5BE46A6D0FF83FE3
1EE8D6791734EE233ABC2D6E7C98463D9C2791C931A6EF009DB0B79338E7C922BA5789AA983E6C60F0F72F3B2FF0443734AB77393B332F497DD54449112AC129
535AADCE86F3BBF5AECFBA8EA3AEA81F920F77EAF6D15DADE9404BE67964AFCCF310B8E26AC2E82FE273CF900AC2B75D09DDD9E70D66D2BDE0DA454FF4F7C7AE
76EE2C75F6999D9AB81E1847B34C1C27F17354A62462C57AF4B2EF0C862AB01C92505682C9CA0F0AAE64B89FFC4F0A875DE1A50EBC720BB9A0D7D4352BD6ACBE
2E6193C2267851396DE33E7F7AAF0472A5DB0C02E5B304160B6EC755B2F27D008B66CBDD976115E04D374CEA8BC938253D132C27F137EBD6D43E15A0C207ACDF
304813102A08F0DC7566E2818045F161BB01336749DAB86D04626331F91820D575C9C5884CF5D194031284F6C229A3F0095FE2CF4C52FCA52919A422C5AC0D9E
C8B68F017D9CAB5A9C9192E89E9DD089B27D731D702EF89C3E0174EE79F55E1E4398A3BF5CED006176FD0C5004E61DB2F0C8A8794A4AE528F288F2C764B2A19D
D7E475ADDB363E932E93A0D4D211C1F579D256FC96A37AA4C50D820FDE67315EDADF898D0B699DB8C76594E041FB6B3F4F5450A83D91C21ABC5662EF78A0216F
079EDA84BC6D4F7AF2309B966AB0CDA8AE8840F32A09482E081BBEC9B194703524686DA45927F4B0AACB1B57EF2F826C108DDA312E3EFDE60C672BD1E8C8627D
3D8D38A95A356D0FD9D2F782AA2E5DAD89D4DF9DFF329C0D6C778AD9C1CFC55865BEBA8C69A3D7C0D055801AD29EE85F99993B90624450CE1CDFE953BCEB5686
59278649054FA3872F263F8AC6F3A68D6265F21EC225D93307BEAB23C6A78965092289977DB8B978C173C4043B900D76EBF10CFCEFD9D71AFF872A28921664CA
2486821014B74BC9A91D95F65B3A3725768393DBBDF63D4B04A12B3DC3B3D55FE22B858D7730313021300906052B0E03021A05000414E48BA46C1BB2FA66393C
FF3A9969E856B718DB5B0408156441DE133D035702020400';

begin
   l_property_value := cwms_properties.get_property('CWMSDB', 'oracle.wallet.filename', null, 'CWMS');
   
   select distinct substr(name, 1, regexp_instr(name, cwms_util.get_db_name, 1, 1, 1)-1) 
     bulk collect
     into l_directory_names
     from v$datafile;
     
   if l_property_value is null then
      l_property_value := l_directory_names(1);
      cwms_properties.set_property('CWMSDB', 'oracle.wallet.filename', l_property_value, 'Location of Oracle Wallet', 'CWMS');
   end if;
   
   dbms_output.put_line('==='||chr(10)||'=== Oracle Wallet Directory is '||l_property_value||chr(10)||'==='); 
   
   execute immediate 'create or replace directory WALLET_DIR as '''||l_property_value||'''';
   
   l_filename  := 'cwallet.sso';
   l_file := utl_file.fopen('WALLET_DIR', l_filename, 'wb');
   l_text := cwms_util.split_text(trim(l_cwallet_text), chr(10));
   for i in 1..l_text.count loop
      utl_file.put_raw(l_file, hextoraw(l_text(i)));
   end loop;
   utl_file.fflush(l_file);
   utl_file.fclose(l_file);
   select sum(length(column_value)) / 2 into l_len from table(l_text);
   dbms_output.put_line('Wrote '||l_len||' bytes to file '||l_property_value||'/'||l_filename);
   
   l_filename  := 'ewallet.p12';
   l_file := utl_file.fopen('WALLET_DIR', l_filename, 'wb');
   l_text := cwms_util.split_text(trim(l_ewallet_text), chr(10));
   for i in 1..l_text.count loop
      utl_file.put_raw(l_file, hextoraw(l_text(i)));
   end loop;
   utl_file.fflush(l_file);
   utl_file.fclose(l_file);
   select sum(length(column_value)) / 2 into l_len from table(l_text);
   dbms_output.put_line('Wrote '||l_len||' bytes to file '||l_property_value||'/'||l_filename);
end;
/