buildscript {
    dependencies {
        classpath "com.oracle.database.jdbc:ojdbc8:$ORACLE_JDBC_VERSION"
    }

}

plugins {
    id 'java'
    id 'org.flywaydb.flyway' version '8.4.4'
}

configurations {
    compile
    flywayMigration
}

dependencies {
    implementation "org.flywaydb:flyway-core:8.4.4"
    compile "org.flywaydb:flyway-core:8.4.4"
    flywayMigration "com.oracle.database.jdbc:ojdbc8:$ORACLE_JDBC_VERSION"
    flywayMigration sourceSets.main.runtimeClasspath
}

var build_user = project.getProperty("cwms.user")

flyway {
    locations = ["db/schema"]
    configurations = ['flywayMigration','compile','runtimeClasspath']
    user = build_user
    /*url = "$DB_URL"
    user = BUILD_USER
    password = BUILD_USERPASSWORD*/
    resolvers =  ['cwms.resolvers.DependsOnPackageResolver']
    mixed = true
    schemas = ['CWMS_20','CWMS_DBA']
    placeholders = [
        "CWMS_SCHEMA": "CWMS_20",
        "CWMS_SCHEMA_AUTH": "no authentication", // override on commandline with identified by portion if needed.
        "CWMS_DBA_AUTH": "no authentication",
        "CWMS_TABLESPACE": "CWMS_20DATA",
        "AT_TABLESPACE": "CWMS_20ATDATA",
        "AQ_TABLESPACE": "CWMS_AQ",
        "AQ_EX_TABLESPACE": "CWMS_AQ_EX",
        "CWMS_OFFICE_ID": project.findProperty("cwms.office") ?:"SPK",
        "CWMS_OFFICE_EROC": project.findProperty("cwms.eroc") ?:"l2" //TODO: change to lookup once this data is in a resource file
    ]
}

task dataMigrate(type: org.flywaydb.gradle.task.FlywayMigrateTask){ /*  dependsOn: flywayMigrate){*/
    locations = ["db/data"]
    configurations = ['flywayMigration','compile','runtimeClasspath']
    user = "${build_user}[CWMS_20]"
    url = flyway.url
    password = flyway.password
    mixed = true
    table = "flyway_data_history"
    baselineOnMigrate = true // The structure migration task has already created a table here. We need a 2nd one.
    schemas = ['CWMS_20']
    placeholders = [
        "CWMS_SCHEMA": "CWMS_20"
    ]
}

task dataRepair(type: org.flywaydb.gradle.task.FlywayRepairTask){
    locations = ["db/data"]
    configurations = ['flywayMigration','compile','runtimeClasspath']
    user = "${build_user}[CWMS_20]"
    url = flyway.url
    password = flyway.password
    mixed = true
    table = "flyway_data_history"
    baselineOnMigrate = true // The structure migration task has already created a table here. We need a 2nd one.
    schemas = ['CWMS_20']
    placeholders = [
        "CWMS_SCHEMA": "CWMS_20"
    ]
}

flywayMigrate.dependsOn classes
flywayClean.dependsOn classes
flywayRepair.dependsOn classes
dataMigrate.dependsOn classes
dataRepair.dependsOn classes