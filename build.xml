<project name="wcdba" default="all">
	<description>
		"Build file for the oracle side of the WCDBA project."
	</description>

	<!-- read in the environment for use in properties -->
	<property environment="env"/>

	<!-- whether or not this build is a debug build -->
	<property name="debug"  value="true"/>

	<!-- the amount of memory to allocate to javac during compile -->
	<property name="memMax" value="256m"/>

	<!-- flag to create the test account -->
	<property name="test.account.create" value="-testaccount"/>

	<!-- flags to control output of auto kill and auto build -->
	<property name="autobuild.echo" value="OFF"/>
	<property name="autokill.echo" value="OFF"/>

	<!-- flags to force the kill script to ignore errors. -->
	<property name="autokill.force" value="-force"/>
	
	<!-- Perforce properties -->
	<!-- Fail perforce operations on error -->
	<property name="perforce.failOnError" value="true"/>
	<!-- If the perforce.disabled property is defined to anything perforce
		 operations will not occur. To enable perforce comment out the 
		 'perforce.disabled' property. To disable, remove the comments.
	-->
	<!-- property name="perforce.disabled" value="true"/ -->
	<!-- The perforce depot name for this project -->
	<property name="perforce.depot" value="//wcdba/dev/oracle/dev/..."/>

	<!-- set file locations for this build -->
	<property name="root"  location="."/>
	<property name="src" location="${root}/src"/>
	<property name="lib"  location="${root}/lib"/>
	<property name="test"  location="${root}/test"/>

	<!-- Load in the ant-contrib jar to use the foreach external task -->	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${root}/lib/ant-contrib.jar"/>
		</classpath>
	</taskdef>	

	<import optional="true" file="${root}/${env.USERNAME}.xml"/>
	<import optional="true" file="${builduser.overrides}"/>

	<!-- Initialize the project for building. -->
	<target name="init">
		<!-- Create the time stamp -->
		<tstamp/>
		<property name="wcdba.build" value="WCDBA:Build:${DSTAMP}:${TSTAMP}"/>
		<condition property="perforce.enabled">
			<not>
				<isset property="perforce.disabled"/>
			</not>
		</condition>
		<echo message="perforce.enabled = ${perforce.enabled}"/>
	</target>
	
	<!-- Executes python scripts to build the CWMS_20 schema. -->
	<target name="build" description="Executes python scripts to build the CWMS_20 schema">		
		
		<echo message="Build sql scripts..."/>
		
		<if>
			<equals arg1="${office.secondary.id}" arg2="" />
			<then>
				<property name="buildSqlScript-arg-line" value="/c python buildSqlScripts.py ${oracle.cwms.user} ${office.primary.id} ${test.account.create}"/>
				<echo message="${buildSqlScript-arg-line}"/>
			</then>
			<else>
				<property name="buildSqlScript-arg-line" value="/c python buildSqlScripts.py ${oracle.cwms.user} ${office.primary.id} ${office.secondary.id} ${test.account.create}"/>
				<echo message="${buildSqlScript-arg-line}"/>
			</else>
		</if>
		
		<exec dir="${src}" executable="cmd" outputproperty="build-sql-script-output" errorproperty="build-sql-script-error">
			<arg line="${buildSqlScript-arg-line}"/>
		</exec>
		
		<if>
			<equals arg1="${build-sql-script-error}" arg2="" />
			<then>
				<echo message="Finished building sql scripts"/>
			</then>
			<else>
				<echo message="${build-sql-script-output}"/>
				<fail message="buildsqlscripts.py is failing with the following error code: ${build-sql-script-error}"/>
			</else>
		</if>
		
		<echo message="Creating new CWMS20 Schema..."/>

		<property name="autobuild-arg-line" value="/c python autobuild.py echo=${autobuild.echo} inst=${oracle.cwms.instance} sys_passwd=${oracle.sys.password} 
cwms_passwd=${oracle.cwms20.password} dbi_passwd=${oracle.cwmsdbi.password} test_passwd=${oracle.hectest.password}"/>
		<echo message="${autobuild-arg-line}"/>

		<exec dir="${src}" executable="cmd" outputproperty="auto-build-output" errorproperty="auto-build-error">
			<arg line="${autobuild-arg-line}"/>
		</exec>
		
		<if>
			<equals arg1="${auto-build-error}" arg2="" />
			<then>
				<echo message="Finished creating new CWMS20 Schema"/>
			</then>
			<else>
				<echo message="${auto-build-output}"/>
				<fail message="autobuild.py is failing with the following error code: ${auto-build-error}"/>
			</else>
		</if>

    </target>
	
	<!-- Executes python script to drop the CWMS_20 schema. -->
	<target name="clean" description="Executes python script to drop the CWMS_20 schema">
		
		<echo message="dropping existing CWMS20 Schema..."/>
		
		<property name="autokill-arg-line" value="/c python autokill.py echo=${autokill.echo} inst=${oracle.cwms.instance} sys_passwd=${oracle.sys.password} ${autokill.force}"/>
		<echo message="${autokill-arg-line}"/>
		
		<exec dir="${src}" executable="cmd" outputproperty="auto-kill-output" errorproperty="auto-kill-error">
			<arg line="${autokill-arg-line}"/>
		</exec>	
		
		<if>
			<equals arg1="${auto-kill-error}" arg2="" />
			<then>
				<echo message="Finished dropping existing CWMS20 Schema"/>
			</then>
			<else>
				<echo message="${auto-kill-output}"/>
				<fail message="autokill.py is failing with the following error code: ${auto-kill-error}"/>
			</else>
		</if>
	
    </target>
	
	<!-- Drop existing CWMS_20 schema then build a new CWMS_20 schema. -->
	<target name="all-schema" depends="clean,build" description="drop existing CWMS_20 schema then build a new CWMS_20 schema">
    </target>
	
    <target name="all" depends="all-schema" description="empty for the moment">
    </target>
	
</project>

